#!/usr/bin/env bash

# ============================================================================
# AI Code Review - Provider-agnostic code review using AI
# ============================================================================
# A standalone CLI tool that validates staged files against your project's
# coding standards using any AI provider (Claude, Gemini, Codex, Ollama, etc.)
# ============================================================================

set -e

VERSION="1.0.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$(dirname "$SCRIPT_DIR")/lib"

# Source provider functions
source "$LIB_DIR/providers.sh"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Defaults
DEFAULT_FILE_PATTERNS="*"
DEFAULT_RULES_FILE="AGENTS.md"
DEFAULT_STRICT_MODE="true"

# ============================================================================
# Helper Functions
# ============================================================================

print_banner() {
  echo ""
  echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "${CYAN}${BOLD}  AI Code Review v${VERSION}${NC}"
  echo -e "${CYAN}  Provider-agnostic code review using AI${NC}"
  echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo ""
}

print_help() {
  print_banner
  echo -e "${BOLD}USAGE:${NC}"
  echo "  ai-code-review <command> [options]"
  echo ""
  echo -e "${BOLD}COMMANDS:${NC}"
  echo "  run           Run code review on staged files"
  echo "  install       Install git pre-commit hook in current repo"
  echo "  uninstall     Remove git pre-commit hook from current repo"
  echo "  config        Show current configuration"
  echo "  init          Create a sample .ai-code-review config file"
  echo "  help          Show this help message"
  echo "  version       Show version"
  echo ""
  echo -e "${BOLD}CONFIGURATION:${NC}"
  echo "  Create a ${CYAN}.ai-code-review${NC} file in your project root or"
  echo "  ${CYAN}~/.config/ai-code-review/config${NC} for global settings."
  echo ""
  echo -e "${BOLD}CONFIG OPTIONS:${NC}"
  echo "  PROVIDER           AI provider to use (required)"
  echo "                     Values: claude, gemini, codex, ollama:<model>"
  echo "  FILE_PATTERNS      File patterns to review (default: *)"
  echo "                     Example: *.ts,*.tsx,*.js,*.jsx"
  echo "  EXCLUDE_PATTERNS   Patterns to exclude from review"
  echo "                     Example: *.test.ts,*.spec.ts,*.d.ts"
  echo "  RULES_FILE         File containing review rules (default: AGENTS.md)"
  echo "  STRICT_MODE        Fail on ambiguous AI response (default: true)"
  echo ""
  echo -e "${BOLD}EXAMPLES:${NC}"
  echo "  ai-code-review init          # Create sample config"
  echo "  ai-code-review install       # Install git hook"
  echo "  ai-code-review run           # Run review manually"
  echo ""
  echo -e "${BOLD}ENVIRONMENT VARIABLES:${NC}"
  echo "  AI_CODE_REVIEW_PROVIDER      Override provider from config"
  echo ""
}

print_version() {
  echo "ai-code-review v${VERSION}"
}

log_info() {
  echo -e "${BLUE}ℹ️  $1${NC}"
}

log_success() {
  echo -e "${GREEN}✅ $1${NC}"
}

log_warning() {
  echo -e "${YELLOW}⚠️  $1${NC}"
}

log_error() {
  echo -e "${RED}❌ $1${NC}"
}

# ============================================================================
# Configuration Loading
# ============================================================================

load_config() {
  # Reset to defaults
  PROVIDER=""
  FILE_PATTERNS="$DEFAULT_FILE_PATTERNS"
  EXCLUDE_PATTERNS=""
  RULES_FILE="$DEFAULT_RULES_FILE"
  STRICT_MODE="$DEFAULT_STRICT_MODE"

  # Load global config first
  GLOBAL_CONFIG="$HOME/.config/ai-code-review/config"
  if [[ -f "$GLOBAL_CONFIG" ]]; then
    source "$GLOBAL_CONFIG"
  fi

  # Load project config (overrides global)
  PROJECT_CONFIG=".ai-code-review"
  if [[ -f "$PROJECT_CONFIG" ]]; then
    source "$PROJECT_CONFIG"
  fi

  # Environment variable overrides everything
  if [[ -n "$AI_CODE_REVIEW_PROVIDER" ]]; then
    PROVIDER="$AI_CODE_REVIEW_PROVIDER"
  fi
}

# ============================================================================
# Commands
# ============================================================================

cmd_config() {
  print_banner
  load_config

  echo -e "${BOLD}Current Configuration:${NC}"
  echo ""
  
  # Check config sources
  GLOBAL_CONFIG="$HOME/.config/ai-code-review/config"
  PROJECT_CONFIG=".ai-code-review"
  
  echo -e "${BOLD}Config Files:${NC}"
  if [[ -f "$GLOBAL_CONFIG" ]]; then
    echo -e "  Global:  ${GREEN}$GLOBAL_CONFIG${NC}"
  else
    echo -e "  Global:  ${YELLOW}Not found${NC}"
  fi
  
  if [[ -f "$PROJECT_CONFIG" ]]; then
    echo -e "  Project: ${GREEN}$PROJECT_CONFIG${NC}"
  else
    echo -e "  Project: ${YELLOW}Not found${NC}"
  fi
  echo ""

  echo -e "${BOLD}Values:${NC}"
  if [[ -n "$PROVIDER" ]]; then
    echo -e "  PROVIDER:          ${GREEN}$PROVIDER${NC}"
  else
    echo -e "  PROVIDER:          ${RED}Not configured${NC}"
  fi
  echo -e "  FILE_PATTERNS:     ${CYAN}$FILE_PATTERNS${NC}"
  if [[ -n "$EXCLUDE_PATTERNS" ]]; then
    echo -e "  EXCLUDE_PATTERNS:  ${CYAN}$EXCLUDE_PATTERNS${NC}"
  else
    echo -e "  EXCLUDE_PATTERNS:  ${YELLOW}None${NC}"
  fi
  echo -e "  RULES_FILE:        ${CYAN}$RULES_FILE${NC}"
  echo -e "  STRICT_MODE:       ${CYAN}$STRICT_MODE${NC}"
  echo ""

  # Check if rules file exists
  if [[ -f "$RULES_FILE" ]]; then
    echo -e "${BOLD}Rules File:${NC} ${GREEN}Found${NC}"
  else
    echo -e "${BOLD}Rules File:${NC} ${RED}Not found ($RULES_FILE)${NC}"
  fi
  echo ""
}

cmd_init() {
  print_banner
  
  PROJECT_CONFIG=".ai-code-review"
  
  if [[ -f "$PROJECT_CONFIG" ]]; then
    log_warning "Config file already exists: $PROJECT_CONFIG"
    read -p "Overwrite? (y/N): " confirm
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
      echo "Aborted."
      exit 0
    fi
  fi

  cat > "$PROJECT_CONFIG" << 'EOF'
# AI Code Review Configuration
# https://github.com/your-org/ai-code-review

# AI Provider (required)
# Options: claude, gemini, codex, ollama:<model>
# Examples:
#   PROVIDER="claude"
#   PROVIDER="gemini"
#   PROVIDER="codex"
#   PROVIDER="ollama:llama3.2"
#   PROVIDER="ollama:codellama"
PROVIDER="claude"

# File patterns to include in review (comma-separated)
# Default: * (all files)
# Examples:
#   FILE_PATTERNS="*.ts,*.tsx"
#   FILE_PATTERNS="*.py"
#   FILE_PATTERNS="*.go,*.mod"
FILE_PATTERNS="*.ts,*.tsx,*.js,*.jsx"

# File patterns to exclude from review (comma-separated)
# Default: none
# Examples:
#   EXCLUDE_PATTERNS="*.test.ts,*.spec.ts"
#   EXCLUDE_PATTERNS="*_test.go,*.mock.ts"
EXCLUDE_PATTERNS="*.test.ts,*.spec.ts,*.test.tsx,*.spec.tsx,*.d.ts"

# File containing code review rules
# Default: AGENTS.md
RULES_FILE="AGENTS.md"

# Strict mode: fail if AI response is ambiguous
# Default: true
STRICT_MODE="true"
EOF

  log_success "Created config file: $PROJECT_CONFIG"
  echo ""
  log_info "Next steps:"
  echo "  1. Edit $PROJECT_CONFIG to set your preferred provider"
  echo "  2. Create $DEFAULT_RULES_FILE with your coding standards"
  echo "  3. Run: ai-code-review install"
  echo ""
}

cmd_install() {
  print_banner

  # Check if we're in a git repo
  if ! git rev-parse --git-dir > /dev/null 2>&1; then
    log_error "Not a git repository"
    exit 1
  fi

  GIT_ROOT=$(git rev-parse --show-toplevel)
  HOOK_PATH="$GIT_ROOT/.git/hooks/pre-commit"

  # Check if hook already exists
  if [[ -f "$HOOK_PATH" ]]; then
    if grep -q "ai-code-review" "$HOOK_PATH"; then
      log_warning "AI Code Review hook already installed"
      exit 0
    else
      log_warning "A pre-commit hook already exists"
      read -p "Append AI Code Review to existing hook? (y/N): " confirm
      if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
        echo "Aborted."
        exit 0
      fi
      # Append to existing hook
      echo "" >> "$HOOK_PATH"
      echo "# AI Code Review" >> "$HOOK_PATH"
      echo 'ai-code-review run || exit 1' >> "$HOOK_PATH"
      log_success "Appended AI Code Review to existing hook"
      exit 0
    fi
  fi

  # Create new hook
  cat > "$HOOK_PATH" << 'EOF'
#!/usr/bin/env bash
# Git pre-commit hook - AI Code Review

ai-code-review run || exit 1
EOF

  chmod +x "$HOOK_PATH"
  log_success "Installed pre-commit hook: $HOOK_PATH"
  echo ""
}

cmd_uninstall() {
  print_banner

  # Check if we're in a git repo
  if ! git rev-parse --git-dir > /dev/null 2>&1; then
    log_error "Not a git repository"
    exit 1
  fi

  GIT_ROOT=$(git rev-parse --show-toplevel)
  HOOK_PATH="$GIT_ROOT/.git/hooks/pre-commit"

  if [[ ! -f "$HOOK_PATH" ]]; then
    log_warning "No pre-commit hook found"
    exit 0
  fi

  if ! grep -q "ai-code-review" "$HOOK_PATH"; then
    log_warning "AI Code Review hook not found in pre-commit"
    exit 0
  fi

  # Check if it's our hook only or mixed
  if grep -q "^ai-code-review run" "$HOOK_PATH" && [[ $(wc -l < "$HOOK_PATH") -le 5 ]]; then
    # It's only our hook, remove the file
    rm "$HOOK_PATH"
    log_success "Removed pre-commit hook"
  else
    # Mixed hook, just remove our lines
    sed -i.bak '/# AI Code Review/d' "$HOOK_PATH"
    sed -i.bak '/ai-code-review run/d' "$HOOK_PATH"
    rm -f "$HOOK_PATH.bak"
    log_success "Removed AI Code Review from pre-commit hook"
  fi
  echo ""
}

cmd_run() {
  print_banner
  load_config

  # Validate provider is configured
  if [[ -z "$PROVIDER" ]]; then
    log_error "No provider configured"
    echo ""
    echo "Configure a provider in .ai-code-review or set AI_CODE_REVIEW_PROVIDER"
    echo "Run 'ai-code-review init' to create a config file"
    echo ""
    exit 1
  fi

  # Validate provider is available
  if ! validate_provider "$PROVIDER"; then
    exit 1
  fi

  # Check rules file exists
  if [[ ! -f "$RULES_FILE" ]]; then
    log_error "Rules file not found: $RULES_FILE"
    echo ""
    echo "Please create a ${BOLD}$RULES_FILE${NC} file with your coding standards."
    echo ""
    echo "Example content:"
    echo "  # Code Review Rules"
    echo "  "
    echo "  ## TypeScript"
    echo "  - Use const/let, never var"
    echo "  - Prefer interfaces over types"
    echo "  - No any types"
    echo "  "
    echo "  ## React"
    echo "  - Use functional components"
    echo "  - Prefer named exports"
    echo ""
    exit 1
  fi

  log_info "Provider: $PROVIDER"
  log_info "Rules file: $RULES_FILE"
  log_info "File patterns: $FILE_PATTERNS"
  if [[ -n "$EXCLUDE_PATTERNS" ]]; then
    log_info "Exclude patterns: $EXCLUDE_PATTERNS"
  fi
  echo ""

  # Get staged files
  STAGED_FILES=$(get_staged_files "$FILE_PATTERNS" "$EXCLUDE_PATTERNS")

  if [[ -z "$STAGED_FILES" ]]; then
    log_warning "No matching files staged for commit"
    echo ""
    exit 0
  fi

  echo -e "${BOLD}Files to review:${NC}"
  echo "$STAGED_FILES" | while IFS= read -r file; do
    echo "  - $file"
  done
  echo ""

  # Read rules
  RULES=$(cat "$RULES_FILE")

  # Build prompt
  PROMPT=$(build_prompt "$RULES" "$STAGED_FILES")

  # Execute review
  log_info "Sending to $PROVIDER for review..."
  echo ""

  RESULT=$(execute_provider "$PROVIDER" "$PROMPT")
  EXEC_STATUS=$?

  if [[ $EXEC_STATUS -ne 0 ]]; then
    log_error "Provider execution failed"
    if [[ "$STRICT_MODE" == "true" ]]; then
      exit 1
    fi
    exit 0
  fi

  echo "$RESULT"
  echo ""

  # Parse result
  if echo "$RESULT" | grep -q "^STATUS: PASSED"; then
    log_success "CODE REVIEW PASSED"
    echo ""
    exit 0
  elif echo "$RESULT" | grep -q "^STATUS: FAILED"; then
    log_error "CODE REVIEW FAILED"
    echo ""
    echo "Fix the violations listed above before committing."
    echo ""
    exit 1
  else
    log_warning "Could not determine review status"
    if [[ "$STRICT_MODE" == "true" ]]; then
      log_error "STRICT MODE: Failing due to ambiguous response"
      echo ""
      echo "The AI response must start with 'STATUS: PASSED' or 'STATUS: FAILED'"
      echo "Set STRICT_MODE=false in config to allow ambiguous responses"
      echo ""
      exit 1
    else
      log_warning "Allowing commit (STRICT_MODE=false)"
      echo ""
      exit 0
    fi
  fi
}

# ============================================================================
# Utility Functions
# ============================================================================

get_staged_files() {
  local patterns="$1"
  local excludes="$2"

  # Get all staged files (added, copied, modified)
  local staged=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null)

  if [[ -z "$staged" ]]; then
    return
  fi

  # Convert comma-separated patterns to array
  IFS=',' read -ra PATTERN_ARRAY <<< "$patterns"
  IFS=',' read -ra EXCLUDE_ARRAY <<< "$excludes"

  # Filter files
  echo "$staged" | while IFS= read -r file; do
    local match=false
    local excluded=false

    # Check if file matches any include pattern
    for pattern in "${PATTERN_ARRAY[@]}"; do
      pattern=$(echo "$pattern" | xargs) # trim whitespace
      if [[ "$file" == $pattern ]]; then
        match=true
        break
      fi
    done

    # Check if file matches any exclude pattern
    if [[ "$match" == true && -n "$excludes" ]]; then
      for pattern in "${EXCLUDE_ARRAY[@]}"; do
        pattern=$(echo "$pattern" | xargs) # trim whitespace
        if [[ "$file" == $pattern ]]; then
          excluded=true
          break
        fi
      done
    fi

    if [[ "$match" == true && "$excluded" == false ]]; then
      echo "$file"
    fi
  done
}

build_prompt() {
  local rules="$1"
  local files="$2"

  local prompt="You are a code reviewer. Analyze the files below and validate they comply with the coding standards provided.

=== CODING STANDARDS ===
$rules
=== END CODING STANDARDS ===

=== FILES TO REVIEW ==="

  # Add file contents
  echo "$files" | while IFS= read -r file; do
    if [[ -f "$file" ]]; then
      prompt="$prompt

--- FILE: $file ---
$(cat "$file")"
    fi
  done

  prompt="$prompt

=== END FILES ===

**IMPORTANT: Your response MUST start with exactly one of these lines:**
STATUS: PASSED
STATUS: FAILED

**If FAILED:** List each violation with:
- File name
- Line number (if applicable)
- Rule violated
- Description of the issue

**If PASSED:** Confirm all files comply with the coding standards.

**Start your response now with STATUS:**"

  echo "$prompt"
}

# ============================================================================
# Main
# ============================================================================

main() {
  case "${1:-}" in
    run)
      cmd_run
      ;;
    install)
      cmd_install
      ;;
    uninstall)
      cmd_uninstall
      ;;
    config)
      cmd_config
      ;;
    init)
      cmd_init
      ;;
    version|--version|-v)
      print_version
      ;;
    help|--help|-h|"")
      print_help
      ;;
    *)
      log_error "Unknown command: $1"
      echo ""
      print_help
      exit 1
      ;;
  esac
}

main "$@"
